# Le-Kit Copilot Instructions

## Project Overview

Le-Kit is a **Stencil.js web component library** with a dual-mode system for production (`default`) and CMS editing (`admin`). Components are themeable via CSS custom properties.

## Architecture

### Mode System (Critical Pattern)

- **Mode inheritance** traverses both regular DOM and shadow DOM boundaries using `getMode()` in [src/global/app.ts](src/global/app.ts)
- Set mode via `<html mode="admin">` or on any component: `<le-card mode="admin">`
- Components creating mode boundaries (like `le-popover`) force `mode="default"` on children

### Component Structure Pattern

All editable components follow this pattern:

```tsx
render() {
  return (
    <le-component component="le-card" hostClass={classnames(...)}>
      <div class="card">
        <le-slot name="header" type="text" tag="h3">
          <slot name="header"></slot>
        </le-slot>
        {/* ... */}
      </div>
    </le-component>
  );
}
```

- **`le-component`**: Wrapper providing admin UI (settings popover, property editor)
- **`le-slot`**: Slot placeholder with inline editing (`type="text"|"textarea"`) or dropzone (`type="slot"`)

### Key Internal Components

- **`le-component`** ([src/components/le-component/](src/components/le-component/)): Admin mode wrapper, loads metadata from `/custom-elements.json`
- **`le-slot`** ([src/components/le-slot/](src/components/le-slot/)): Edits slotted content via `slot.assignedNodes({ flatten: true })`

### Shadow DOM Traversal

Mode detection crosses shadow boundaries using `getRootNode()`. See `observeModeChanges()` in [src/utils/utils.ts](src/utils/utils.ts).

## Development Workflow

```bash
npm install
npm start        # Dev server with watch mode (generates entry points + cem analyze first)
npm run build    # Production build + bundles + themes + manifest
npm test         # Run spec and e2e tests
```

### Build Outputs

The build generates multiple distribution formats:

- `le-kit` - Lazy-loaded components (auto-registered)
- `le-kit/core` - Custom elements with admin code **stripped at build time** (smaller bundle)
  - `h("le-component", ...)` → `h(Host, ...)`
  - `h("le-slot", ..., slot)` → `slot`
  - CSS: `:host>le-component.X` → `:host.X`
- `le-kit/admin` - Custom elements with all components including admin UI
- `le-kit/components` - Individual component exports

### Build Scripts

- `scripts/build-targets.mjs` - Generates `src/index-core.ts` and `src/index-admin.ts`
- `scripts/bundle-targets.mjs` - Creates `dist/core/` and `dist/admin/` bundles post-build
- Admin-only components list: `le-component`, `le-slot` (configured in scripts)

### Custom Elements Manifest

- Generated by `@custom-elements-manifest/analyzer` via `cem analyze --stencil`
- Used at runtime by `le-component` to render property editors
- Run `npm run analyze` to regenerate manually

## File Conventions

### Component Files

```
src/components/le-{name}/
├── le-{name}.tsx           # Component implementation
├── le-{name}.default.css   # Default mode styles
├── le-{name}.admin.css     # Admin mode styles (optional)
└── readme.md               # Auto-generated docs
```

### CSS Theming

- [src/themes/base.css](src/themes/base.css): Design tokens (spacing, typography)
- Theme files (`default.css`, `dark.css`, etc.): Color schemes via CSS custom properties
- Component CSS properties prefixed with `--le-{component}-*`

## Coding Patterns

### Mode-Aware State

```tsx
@State() private adminMode: boolean = false;
private disconnectModeObserver?: () => void;

connectedCallback() {
  this.disconnectModeObserver = observeModeChanges(this.el, (mode) => {
    this.adminMode = mode === 'admin';
  });
}

disconnectedCallback() {
  this.disconnectModeObserver?.();
}
```

### Component Documentation

Use JSDoc tags for CMS metadata:

- `@cmsEditable true` - Component appears in CMS picker
- `@cmsInternal true` - System component, hidden from users
- `@cmsCategory Layout` - Category for grouping

### Slot Editing Props

- `type`: `'slot'` (dropzone) | `'text'` (inline) | `'textarea'` (multiline)
- `tag`: HTML tag to create when slot is empty (e.g., `'h3'`, `'p'`)
- `allowed-components`: Comma-separated tags for dropzone filtering
